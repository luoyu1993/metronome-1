/**
 * Metronome
 * Copyright (C) 2018 vm
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
!function(){return function t(e,i,s){function n(o,l){if(!i[o]){if(!e[o]){var r="function"==typeof require&&require;if(!l&&r)return r(o,!0);if(a)return a(o,!0);var u=new Error("Cannot find module '"+o+"'");throw u.code="MODULE_NOT_FOUND",u}var h=i[o]={exports:{}};e[o][0].call(h.exports,function(t){var i=e[o][1][t];return n(i||t)},h,h.exports,t,e,i,s)}return i[o].exports}for(var a="function"==typeof require&&require,o=0;o<s.length;o++)n(s[o]);return n}}()({1:[function(t,e,i){"use strict";const s=4,n=3,a=.02,o=.03,l=.02;e.exports={Metronome:class{constructor(t,e,i,a=4){this._ctx=t,this._baseFrequency=e;const o=t.createGain();o.connect(t.destination),o.gain.value=1/Math.max(s,n),this._gain=t.createGain(),this._gain.connect(o),this._tempo=i,this._beats=a,this._queue=[],this._running=!1,this._loopTimeout=null,this._saveOscilator(this._createOscilator())}get tempo(){return this._tempo}get beats(){return this._beats}setRithm({tempo:t,beats:e}){const i=e!=this._beats;if(this._tempo=t,this._beats=e,this._running)if(i)this._queue=[],this._loop(1,!0);else{if(this._queue.length>0){const{beat:t,time:e}=this._queue[this._queue.length-1];this._queue=[],this._pushIfEarlier(t-1,this._ctx.currentTime,e)}this._loop()}}start(t=1){this._running=!0,this._queue=[],this._loop(t)}toggle(){this._running?this.stop():this.start()}isRunning(){return this._running}reset(){this._queue=[],this._running&&this._loop()}tick(){this._scheduleTick(1,this._ctx.currentTime+l,120)}stop(){this._queue=[],this._running=!1}_loop(t=1,e=!0,i=l){if(null!==this._loopTimeout&&clearTimeout(this._loopTimeout),this._running){if(this._poll(),0===this._queue.length&&(e?this._pushImmediatelly(t,i):this._push(t-1,this._ctx.currentTime)),this._queue.length>0&&this._queue.length<2){const t=this._queue[this._queue.length-1];this._push(t.beat,t.time)}this._loopTimeout=setTimeout(()=>this._loop(),10)}}_poll(){if(this._running&&this._queue.length>0){const t=this._ctx.currentTime,{beat:e,time:i,tempo:s}=this._queue[this._queue.length-1];i-t<.1&&(this._queue.pop(),this._scheduleTick(e,i,s))}}_push(t,e){if(!this._running)return;const i=e+60/this._tempo,s=1+t%this._beats;this._queue.unshift({time:i,beat:s,tempo:this._tempo})}_pushIfEarlier(t,e,i,s=.3){if(!this._running)return;const n=e+60/this._tempo,a=1+t%this._beats;n+s<i?this._queue.unshift({time:n,beat:a,tempo:this._tempo}):this._queue.unshift({time:i,beat:a,tempo:this._tempo})}_pushImmediatelly(t,e){this._queue.unshift({time:this._ctx.currentTime+e,beat:t,tempo:this._tempo})}_scheduleTick(t,e,i){const s=this._createOscilator(),n=this._getBeatDuration(i),a=this._getTickDuration(t),o=Math.min(.7*n,a);this._gain.gain.cancelScheduledValues(0),s.frequency.cancelScheduledValues(0),s.frequency.setValueAtTime(this._getTickFrequency(t),e-.001),this._gain.gain.setValueAtTime(0,e-.001),this._gain.gain.linearRampToValueAtTime(this._getTickGain(),e),this._gain.gain.linearRampToValueAtTime(0,e+o-.001),s.start(e-.001),s.stop(e+o-.001)}_getTickFrequency(t){return 1===t?2*this._baseFrequency:this._baseFrequency}_getTickGain(t){return 1===t?s:n}_getTickDuration(t){return 1===t?a:o}_getBeatDuration(t){return 60/t}_createOscilator(){const t=this._ctx.createOscillator();if(t.connect(this._gain),null!=this._osc){const e=this._osc;return this._saveOscilator(t),e}return t}_saveOscilator(t){this._osc=t}},createAudioContext:()=>{return new(window.AudioContext||window.webkitAudioContext)}}},{}],2:[function(t,e,i){"use strict";const{EventEmitter:s}=t("./util");e.exports=class extends s{constructor(t){super(),this._element=t,this._element.addEventListener("click",this._handleClick.bind(this))}get element(){return this._element}_handleClick(t){this._element.blur(),this.emit("click",t)}}},{"./util":7}],3:[function(t,e,i){"use strict";const{Metronome:s,createAudioContext:n}=t("./audio"),{isMobile:a,EventEmitter:o}=t("./util"),l=t("./toggle"),r=t("./button"),u=t("./tap"),h=t("./tempo-input"),d=!a();window.addEventListener("load",()=>{let t;try{t=n()}catch(p){return void alert("Audio API is not supported in your browser")}const e=new class{constructor(t){this.data=t,this._emitter=new o}update(t){const e=Object.keys(t).filter(e=>this.data[e]!==t[e]);e.length>0&&(this.data={...this.data,...t},this._emitter.emit("change",e))}on(t,e){const i="string"==typeof t?[t]:t;this._emitter.on("change",t=>{let s=!1;for(const e of i)if(t.includes(e)){s=!0;break}s&&e(this.data)})}onAny(t){this._emitter.on("change",()=>t(this.data))}start(){this.update({running:!0})}stop(){this.update({running:!1})}toggle(){this.data.running?this.stop():this.start()}}({tempo:120,beats:4,running:!1}),i=new s(t,864,120),a=new l(document.getElementById("toggle")),c=new u(document.getElementById("tap")),_=Array.from(document.getElementsByClassName("multiplier")).map(t=>new r(t)),m=new h(document.querySelector(".tempo"),e.data.tempo,d);e.on("running",({running:t})=>{a.setRunningState(t),t?i.start():i.stop()}),e.on(["tempo","beats"],({tempo:t,beats:e})=>{const s=Math.round(4*t/e);m.setTempo(s),i.setRithm({tempo:t,beats:e})}),e.on("beats",({beats:t})=>{const e=t/4;m.setMultiplier(e)}),_.forEach(t=>{const i=+t.element.dataset.value;t.on("click",()=>{if(1!==i){if(e.data.tempo*i<500&&e.data.beats*i>=1){const t=Math.round(e.data.beats*i);e.update({tempo:t*e.data.tempo/e.data.beats,beats:Math.round(e.data.beats*i)})}}else e.update({beats:4,tempo:4*e.data.tempo/e.data.beats})})}),document.addEventListener("keydown",t=>{[13,32].includes(t.keyCode)&&(t.preventDefault(),c.tap())}),a.on("toggle",()=>{e.toggle()}),c.on("tempo",t=>{e.update({tempo:t,running:!0})}),c.on("estimate",t=>{e.update({tempo:t})}),c.on("tap",()=>{e.stop(),d&&i.tick()}),m.on("input",t=>{const i=e.data.beats*t/4;e.update({tempo:i})}),m.on("adjust",t=>{const i=e.data.beats*t/4;e.update({tempo:i})}),m.on("set",t=>{const i=e.data.beats*t/4;e.update({tempo:i,running:!0})})})},{"./audio":1,"./button":2,"./tap":4,"./tempo-input":5,"./toggle":6,"./util":7}],4:[function(t,e,i){"use strict";const s=t("./button"),{EventEmitter:n}=t("./util"),a=()=>Date.now(),o=t=>t.length>0?t.reduce((t,e)=>t+e,0)/t.length:null,l=t=>{const e=(t=>{const e=o(t);return null===e?null:t.reduce((t,i)=>t+Math.pow(i-e,2),0)/t.length})(t);return null!=e?Math.sqrt(e):null},r=t=>Math.round(6e4/t),u=4;e.exports=class extends n{constructor(t){super(),this._element=t,this._button=new s(t),this._button.on("click",this._handleTap.bind(this)),this._tapIntervals=[],this._lastMean=null,this._lastStd=null,this._lastTap=null,this._tempo=null,this._blurTimeout=null}tap(){null!==this._blurTimeout&&clearTimeout(this._blurTimeout),this._element.focus(),this._blurTimeout=setTimeout(()=>{this._element.blur()},80),this._handleTap()}_handleTap(){const t=a();if(null===this._lastTap)return this._lastTap=t,void this.emit("tap");const e=t-this._lastTap;if(e>2e3)return this._reset(),void this.emit("tap");this._lastTap=t;const{estimation:i,tempo:s}=this._calculateTempo(e);return null!=i?(this.emit("tap"),void this.emit("estimate",i)):null!=s?null===this._tempo?(this._tempo=s,void this.emit("tempo",s)):Math.abs(this._tempo-s)>.02*this._tempo?(this._tempo=s,void this.emit("tempo",s)):void 0:void this.emit("tap")}_calculateTempo(t){if(this._tapIntervals.push(t),this._tapIntervals.length<u)return{estimation:r(o(this._tapIntervals))};const e=null!=this._lastStd?this._lastStd:l(this._tapIntervals),i=null!=this._lastMean?this._lastMean:o(this._tapIntervals);return Math.abs(t-i)>3*e?(this._reset(),{estimation:null,tempo:null}):(this._tapIntervals=this._tapIntervals.slice(Math.max(0,this._tapIntervals.length-2*u)).filter(t=>Math.abs(t-i)<3*e),this._tapIntervals.length<u?{estimation:r(i)}:(this._lastStd=null!=this._lastStd?l(this._tapIntervals):e,this._lastMean=null!=this._lastMean?o(this._tapIntervals):i,{tempo:Math.round(6e4/i)}))}_reset(){this._tapIntervals=[],this._lastMean=null,this._lastStd=null,this._lastTap=null,this._tempo=null}}},{"./button":2,"./util":7}],5:[function(t,e,i){"use strict";const{getTextNodeAtPosition:s,EventEmitter:n}=t("./util"),a=t=>{const e=Array.from(t.touches).find(t=>0===t.identifier);return e?{x:e.screenX,y:e.screenY}:null};e.exports=class extends n{constructor(t,e,i){if(super(),this._element=t,this._field=t.querySelector(".tempo-input"),this._multiplier=t.querySelector(".tempo-multiplier"),i&&(this._field.contentEditable=!0,this._field.addEventListener("input",t=>{this._handleInput(this._getCurrentInputValue())})),this._field.addEventListener("focus",()=>{this._setToSaveSelection()}),this._field.addEventListener("blur",()=>{this._handleBlur()}),this._field.addEventListener("keydown",t=>{13===t.keyCode?(t.stopPropagation(),this._handleSet()):38===t.keyCode?(t.preventDefault(),t.stopPropagation(),this.emit("input",Math.round(this._lastValidValue+1))):40===t.keyCode&&(t.preventDefault(),t.stopPropagation(),this.emit("input",Math.round(this._lastValidValue-1)))}),this._element.addEventListener("mouseenter",()=>{this._isAboveElement=!0}),this._element.addEventListener("mouseleave",()=>{this._isAboveElement=!1}),document.addEventListener("mousewheel",t=>{this._isAboveElement&&(t.preventDefault(),this._muteNextBlur=!0,this._setToNotSaveSelection(),this._field.blur(),this.emit("input",Math.round(this._lastValidValue-t.deltaY/50)))}),document.addEventListener("mousedown",t=>{this._isAboveElement&&this._handleDragStart(t.pageX,t.pageY)}),document.addEventListener("mousemove",t=>{null!==this._dragStarted&&(this._muteNextBlur=!0,this._setToNotSaveSelection(),this._field.blur(),this._handleDrag(t.pageX,t.pageY))}),document.addEventListener("mouseup",t=>{this._handleDragEnd(t.pageX,t.pageY)}),this._element.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),this._setToNotSaveSelection(),this._field.blur();const e=a(t);this._handleDragStart(e.x,e.y)}),document.addEventListener("touchmove",t=>{t.preventDefault();const e=a(t);this._handleDrag(e.x,e.y)}),document.addEventListener("touchend",t=>{this._handleTouchEnd()}),!this._isValid(e))throw new Error("Initial tempo value is invalid");this._lastValidValue=e,this._setInputValue(e),this._isAboveElement=!1,this._resumeSelectionAt=null,this._isSaveSelection=!0,this._dragStarted=null}setTempo(t){this._isValid(t)&&(this._setInputValue(t),this._lastValidValue=t)}setMultiplier(t){this._multiplier.innerText=t>1?` x${t}`:t<1?` /${1/t}`:""}_handleInput(t){this._isValid(t)&&(this._setInputValue(t),this._dropSavedSelection(),this._lastValidValue=t)}_handleBlur(){const t=this._getCurrentInputValue();this._dropSavedSelection(),this._isValid(t)||this._setInputValue(this._lastValidValue,!1)}_handleSet(){const t=this._getCurrentInputValue();this._isValid(t)?this.emit("set",t):this._setInputValue(this._lastValidValue,!1),this._field.blur()}_handleDragStart(t,e){this._dragStarted={x:t,y:e}}_handleDrag(t,e){if(null===this._dragStarted)return;const i=this._calcDragDelta(t,e);this._dragStarted={x:t,y:e,dragged:!0},this.emit("input",Math.round(this._lastValidValue+i))}_handleDragEnd(t,e){if(null===this._dragStarted)return;const i=this._calcDragDelta(t,e),s=this._dragStarted.dragged;this._dragStarted=null,s&&this.emit("adjust",Math.round(this._lastValidValue+i))}_handleTouchEnd(){null!==this._dragStarted&&(this._dragStarted=null,this.emit("adjust",this._lastValidValue))}_calcDragDelta(t,e){const i=.707,s=-.707,n=t-this._dragStarted.x,a=e-this._dragStarted.y;return Math.round(.1*(i*n+s*a))}_isValid(t){return!isNaN(t)&&t>=30&&t<=600}_getCurrentInputValue(){return Math.round(+this._field.innerText.replace(/\D/g,""))}_setInputValue(t){this._isSaveSelection?(this._saveSelection(),this._field.innerText=t,this._restoreSelection()):(this._dropSavedSelection(),this._field.innerText=t)}_saveSelection(){const t=window.getSelection();if(t.rangeCount>0){const e=t.getRangeAt(0);e.setStart(this._field,0),this._resumeSelectionAt=e.toString().length}}_restoreSelection(){if(null!==this._resumeSelectionAt&&this._resumeSelectionAt>0){const t=window.getSelection(),e=s(this._field,this._resumeSelectionAt);t.removeAllRanges();const i=new Range;i.setStart(e.node,e.position),t.addRange(i)}}_dropSavedSelection(){this._resumeSelectionAt=null,this._setToNotSaveSelection()}_setToSaveSelection(){this._isSaveSelection=!0}_setToNotSaveSelection(){this._isSaveSelection=!1}}},{"./util":7}],6:[function(t,e,i){"use strict";const{addClass:s,removeClass:n,EventEmitter:a}=t("./util"),o=t("./button");e.exports=class extends a{constructor(t){super(),this._button=new o(t),this._element=t,this._button.on("click",()=>this.emit("toggle"))}setRunningState(t){t?this.setStarted():this.setStopped()}setStarted(){s(this._element,"toggle--play"),this._element.innerText="Stop"}setStopped(){n(this._element,"toggle--play"),this._element.innerText="Start"}}},{"./button":2,"./util":7}],7:[function(t,e,i){"use strict";const s=(t,e)=>{t.className.includes(e)||(t.className=t.className.split(" ").filter(t=>t.length>0).filter(t=>t!=e).concat([e]).join(" "))},n=(t,e)=>{t.className.includes(e)&&(t.className=t.className.split(" ").filter(t=>t.length>0).filter(t=>t!=e).join(" "))};var a;e.exports={addClass:s,removeClass:n,toggleClass:(t,e)=>{t.className.includes(e)?n(t,e):s(t,e)},isMobile:()=>{var t=!1;return a=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))&&(t=!0),t},getTextNodeAtPosition:(t,e)=>{var i=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,t=>e>t.textContent.length?(e-=t.textContent.length,NodeFilter.FILTER_REJECT):NodeFilter.FILTER_ACCEPT).nextNode();return{node:i||t,position:i?e:0}},EventEmitter:class{constructor(){this._listeners={}}on(t,e){this._listeners[t]!==undefined?this._listeners[t].push(e):this._listeners[t]=[e]}emit(t,...e){if(this._listeners[t]!==undefined)for(const i of this._listeners[t])i(...e)}}}},{}]},{},[3]);